name: ğŸš€ Deploy Laravel + React to Namecheap via FTP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup Node
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # Step 3: Build React
      - name: ğŸ§± Build React frontend
        run: |
          cd resources/js
          npm install
          npm run build

      # Step 4: Read the Vite manifest to get dynamic filenames
      - name: ğŸ” Read Vite Manifest
        id: vite-manifest
        run: |
          echo "=== Reading Vite Manifest ==="
          MANIFEST_FILE="public/build/.vite/manifest.json"
          
          if [ -f "$MANIFEST_FILE" ]; then
            echo "Manifest file found:"
            cat $MANIFEST_FILE
            
            # Extract the main JS file
            JS_FILE=$(jq -r '.["resources/js/app.jsx"].file' $MANIFEST_FILE)
            echo "Main JS file: $JS_FILE"
            echo "js_file=$JS_FILE" >> $GITHUB_OUTPUT
            
            # Extract CSS files if any
            CSS_FILES=$(jq -r '.["resources/js/app.jsx"].css[]? // empty' $MANIFEST_FILE)
            echo "CSS files: $CSS_FILES"
            echo "css_files=$CSS_FILES" >> $GITHUB_OUTPUT
            
          else
            echo "âŒ Manifest file not found!"
            # Fallback: find the JS file manually
            JS_FILE=$(find public/build/assets -name "app-*.js" | head -1)
            JS_FILE=$(basename $JS_FILE)
            echo "Fallback JS file: $JS_FILE"
            echo "js_file=$JS_FILE" >> $GITHUB_OUTPUT
          fi

      # Step 5: Create dynamic Blade file
      - name: ğŸ”§ Create Dynamic Blade File
        run: |
          BLADE_FILE="resources/views/welcome.blade.php"
          JS_FILENAME="${{ steps.vite-manifest.outputs.js_file }}"
          CSS_FILES="${{ steps.vite-manifest.outputs.css_files }}"
          
          echo "Creating Blade file with JS: $JS_FILENAME"
          echo "CSS files: $CSS_FILES"
          
          # Start building the Blade file
          cat > $BLADE_FILE << EOF
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Your App</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
EOF

          # Add CSS links if they exist
          if [ ! -z "$CSS_FILES" ]; then
            echo "$CSS_FILES" | while read -r css_file; do
              if [ ! -z "$css_file" ]; then
                echo "    <link rel=\"stylesheet\" href=\"/build/$css_file\">" >> $BLADE_FILE
              fi
            done
          fi

          # Close head and add body with JS
          cat >> $BLADE_FILE << EOF
</head>
<body>
    <div id="app"></div>
    
    <!-- Load the built JavaScript -->
    <script type="module" src="/build/$JS_FILENAME"></script>
</body>
</html>
EOF

          echo "âœ… Dynamic Blade file created!"
          echo "=== Final Blade file content ==="
          cat $BLADE_FILE

      # Step 6: Setup PHP
      - name: ğŸ§© Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      # Step 7: Install Composer
      - name: ğŸ“¦ Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      # Step 8: Install jq for JSON parsing (if not already available)
      - name: ğŸ“¦ Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Step 9: Deploy
      - name: ğŸš€ Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.5
        with:
          server: ftp.asktechnologies.net
          username: askftp@asktechnologies.net
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /home/
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/**
            **/vendor/**
            **/storage/**
            **/.env.example
            **/README.md

      # Step 10: Final instructions
      - name: âœ… Deployment Complete
        run: |
          echo "ğŸš€ Dynamic deployment finished!"
          echo " "
          echo "ğŸ“ Built files:"
          echo "JS: ${{ steps.vite-manifest.outputs.js_file }}"
          echo "CSS: ${{ steps.vite-manifest.outputs.css_files }}"
          echo " "
          echo "ğŸ”„ Force refresh your browser (Ctrl+Shift+R)"