name: ðŸš€ Deploy Laravel + React to Namecheap via FTP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup Node
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # Step 3: Build React
      - name: ðŸ§± Build React frontend
        run: |
          cd resources/js
          npm install
          npm run build

      # Step 4: Find the built JS file
      - name: ðŸ” Find Built JS File
        id: find-js
        run: |
          JS_FILE=$(find public/build/assets -name "app-*.js" | head -1)
          JS_FILENAME=$(basename "$JS_FILE")
          echo "Found JS file: $JS_FILENAME"
          echo "js_file=$JS_FILENAME" >> $GITHUB_OUTPUT

      # Step 5: Create dynamic Blade file
      - name: ðŸ”§ Create Dynamic Blade File
        run: |
          BLADE_FILE="resources/views/welcome.blade.php"
          JS_FILENAME="${{ steps.find-js.outputs.js_file }}"
          
          cat > "$BLADE_FILE" << EOL
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Your App</title>
</head>
<body>
    <div id="app"></div>
    <script type="module" src="/build/assets/$JS_FILENAME"></script>
</body>
</html>
EOL
          echo "âœ… Dynamic Blade file created with JS: $JS_FILENAME"

      # Step 6: Setup PHP
      - name: ðŸ§© Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      # Step 7: Install Composer
      - name: ðŸ“¦ Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      # Step 8: Deploy
      - name: ðŸš€ Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.5
        with:
          server: ftp.asktechnologies.net
          username: askftp@asktechnologies.net
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /home/
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/**
            **/vendor/**
            **/storage/**
            **/.env.example
            **/README.md

      # Step 9: Final instructions
      - name: âœ… Deployment Complete
        run: |
          echo "ðŸš€ Deployment finished!"
          echo "Loaded JS file: ${{ steps.find-js.outputs.js_file }}"
          echo "ðŸ”„ Force refresh your browser (Ctrl+Shift+R)"