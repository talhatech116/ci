name: ğŸš€ Deploy Laravel + React to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout code
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup Node.js for React build
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # Step 3: Build React frontend
      - name: ğŸ§± Build React frontend
        run: |
          cd resources/js
          npm install
          npm run build
          echo "âœ… React build completed"

      # Step 4: Verify build files
      - name: ğŸ” Verify Build Output
        run: |
          echo "ğŸ“ Build directory contents:"
          ls -la public/build/
          echo "ğŸ“„ Built JavaScript files:"
          find public/build -name "*.js" -type f

      # Step 5: Setup PHP for Laravel
      - name: ğŸ§© Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      # Step 6: Install Composer dependencies
      - name: ğŸ“¦ Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      # Step 7: Create production .htaccess (if missing)
      - name: ğŸ”§ Ensure .htaccess exists
        run: |
          if [ ! -f .htaccess ]; then
            cat > .htaccess << 'EOF'
          <IfModule mod_rewrite.c>
              RewriteEngine On
              RewriteRule ^(.*)$ public/$1 [L]
          </IfModule>
          EOF
            echo "âœ… Created .htaccess file"
          else
            echo "âœ… .htaccess already exists"
          fi

      # Step 8: Create dynamic Blade file that loads built React assets
      - name: ğŸ”§ Create Production Blade File
        run: |
          # Find the latest built JS file
          JS_FILE=$(find public/build/assets -name "app-*.js" | head -1)
          JS_FILENAME=$(basename "$JS_FILE")
          
          echo "ğŸ“„ Using built JS file: $JS_FILENAME"
          
          # Create the production Blade file
          cat > resources/views/welcome.blade.php << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <title>Your App</title>
          </head>
          <body>
              <div id="app"></div>
              <script type="module" src="/build/assets/$JS_FILENAME"></script>
          </body>
          </html>
          EOF
          
          echo "âœ… Production Blade file created with dynamic JS loading"

      # Step 9: Deploy everything to server
      - name: ğŸš€ Deploy to Production
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.asktechnologies.net
          username: askftp@asktechnologies.net
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /
          exclude: |
            **/.git*
            **/.github*
            **/.env*
            **/node_modules/**
            **/storage/framework/**

      # Step 10: Deployment success
      - name: âœ… Deployment Complete
        run: |
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "ğŸ“ Your changes are now live at: https://test.asktechnologies.net"
          echo "ğŸ”„ If you don't see changes, force refresh: Ctrl+Shift+R"